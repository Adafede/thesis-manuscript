## TIMA {.page_break_before}

This chapter describes improvements that were made to the *Taxonomically Informed Metabolite Annotation* ([TIMA](#tima)) workflow (see Chapter @sec:tima) after publication [@doi:10.3389/fpls.2019.01329].
It addresses the main weaknesses of the published version of the [TIMA](#tima), namely:

- The lack of an accessible chemical compounds occurrences library
- The inability to annotate unconventional adducts
- The complexity of the whole architecture and its automation possibilities

### Library

Accessibility to structure-organism pairs was the major limitation of [TIMA](#tima).
Main resources offering such information were at the time either limited to given organisms, difficult to access in an automatized fashion or closed.
The *Lotus initiative* (Chapter @sec:lotus) addressed this point.
Each potential user can now easily access LOTUS documented structure-organism pairs through various endpoints and use them in [TIMA](#tima).
Different functions are available to download LOTUS locally, complement it by user-specific pairs, and limit the library to given branches of the tree of life.
The number of [2D](#dd) structures able to be re-ranked according to their producing organisms raised to over 140,000.

### Adducts

Another strong limitation was the dependency on the quality and quantity of the initial annotations.
This was a strong limiting factor because of the inability of various tools to annotate other ions than [M+H]^+^.
While annotation tools evolved overcoming these limitations (the [ISDB](#isdb) can now also annotate [M-H]^-^ ions, for example), solutions to overcome them in [TIMA](#tima) directly were implemented.
The first step was to implement adduct detection based on mass differences of detected features in small retention windows.
Based on a list of common adducts (available at <https://github.com/taxonomicallyinformedannotation/tima-r/blob/main/inst/extdata/source/adducts.tsv>), the expected mass difference between both adducts is calculated.
For example, the [M+NH~4~]^+^ adduct of a molecule corresponds to [M] + 18.03383, while [M+Na]^+^ to [M] + 22.98977.
The expected mass difference between both adducts is 22.98977 - 18.03383 = 4.95594.
Therefore, if two features with a mass difference of 4.95594 Â± 10ppm (or any other tolerance) are found in a 0.1min time window (or any other tolerance), they are annotated as [M+NH~4~]^+^ and [M+Na]^+^.
These adducts are then compared to a structural library, for which the mass of each adducted form of all [MF](#mf)s was calculated.
The same reasoning is applied afterwards with a list of common neutral losses.
This leads to additional [MS](#ms)^1^-based annotations in complement to the to the [MS](#ms)^n>1^-based annotations generated by classical annotation workflows.
While these annotations are only based on exact mass matches, their intrinsic score is considered 0 (see Figure @fig:ci-6).
They are kept if they are supported by the taxonomic weight with a given threshold, or by the newly introduced weight, the chemical consistency.

### Chemical Consistency

As shown in Figure @fig:taxo-1, a structural consistency term was foreseen to complement the spectral similarity and taxonomic scores.
At the time of publication, this score was not implemented, but it is now.
A chemical class is attributed to the feature, either through the class of its structural annotation, or by the canopus module from Sirius [@doi:10.1038/s41587-020-0740-8], according to the origin of the initial annotations.
Default chemical classes attributed are the ones of NPClassifier [@doi:10.1021/acs.jnatprod.1c00399].
Then, a consensus chemical class is calculated with the neighbors in the [MN](#mn).
The chemical classes of all neighboring features are taken into account, a consistency score is calculated and if the chemical class is considered consistent (proportion of neighbors sharing the class over 0.5), it is added to the feature (see Figure @fig:ci-6).
This process uses the edges of the [MN](#mn), thus requiring spectra to be clustered before re-ranking the annotations.
As this process uses the concept of neighboring features, common misconceptions of the relations between features are illustrated in Figure @fig:ci-7.

![**Common misconceptions of feature relationships in [MN](#mn).** Two schematic clusters are illustrated, with some classical misinterpretations of the network.](images/ci-7.pdf "ci-7"){#fig:ci-7 short-caption="Common Misconceptions of Feature Relationships in [MN](#mn)" align="center" width="100%"}

Unlike commonly perceived, the main information in [MN](#mn) is in the edges and not the clusters. Clusters can be heavily influenced by the [MN](#mn) size and can be artificially broken because of the maximum features clusters can contain.
To compensate for the above-mentioned, the maximum component size should be set to 0 (corresponding to unlimited cluster size) when building an [MN](#mn), in order to maximize the amount of information captured.
Moreover, edges are often artificially limited to 10 having less congested [MN](#mn)s, which results in a loss of information.
Setting it to the actually allowed maximum (20, because of computation heaviness) is also preferable.
Finally, complementing the spectral similarity edges by [IIN](#iin) edges is another a way to improve the chemical consistency calculation.
IIN will add additional edges through [MS](#ms)^1^-based correlations, thus linking correlated features that were not linked before.

The inclusion of the LOTUS-based [MS](#ms)^1^ annotation step and chemical consistency reranking in the [TIMA](#tima) process is illustrated in Figure @fig:ci-6.

![**Illustration of the improved [TIMA](#tima) process.** Initial annotations are optionally complemented with [MS](#ms)^1^-based annotations from LOTUS, then reranked based on the biological taxonomy score and further reranked based on the chemical taxonomy score.](images/ci-6.pdf "ci-6"){#fig:ci-6 short-caption="Illustration of the Improved [TIMA](#tima) Process" align="center" width="100%"}

The improved [TIMA](#tima) process illustrated in Figure @fig:ci-6 allows for [MS](#ms)^1^-based annotation in addition to the initial [MS^2^](#msms) annotations.
After this optional complementation step, it calculates a first score, based on biological taxonomy, and reranks the candidates accordingly (see Chapter @sec:tima).
It finally calculates a chemical consistency score and further reranks the candidates.

### Benchmarking of the Improved Annotation Performance

Thanks to the improvements detailed above and the growth of publicly available data, the initial benchmarking set of 2,107 spectra (see Figure @fig:taxo-4) could be extended to 22,251.
This benchmarking is the same as illustrated in Figure @fig:ci-5.
A comparison of the annotation performance before and after [TIMA](#tima) is illustrated in Figure @fig:ci-8.

![**Comparison of the annotation performance prior to and post [TIMA](#tima).** In panel A, the distribution of the scores obtained before and after taxonomic weighting are illustrated (the correct annotations are in blue, the incorrect in red). In panel B, the distribution of the obtained ranks are illustrated.](images/ci-8.pdf "ci-8"){#fig:ci-8 short-caption="Comparison of the Annotation Performance Prior to and Post [TIMA](#tima)" align="center" width="100%"}

As mentioned previously, the scores obtained using spectral similarity are not informative (they are almost equally distributed from 0 to 1 for the correct annotations (Figure @fig:ci-8, panel A, left)).
In this sense, no confidence can be attributed to annotations.
In contrast, after taxonomic weighting, the scores from the correct and incorrect annotations are split into two distinct categories (Figure @fig:ci-8, panel A, right).
The ranking of correct candidates is also improved (Figure @fig:ci-8, panel B, right).
The different peaks are due to the discreteness of the taxonomical score. 
A more detailed view of the contribution of the different improvements is illustrated in Figure @fig:ci-9.

![**Percentage of correct annotations as function of the rank.** The lines show the percentage of correct annotations as a function of the rank. The pink line represents the results from the [ISDB](#isdb) annotation without weighting. The blue lines represent the results after [TIMA](#tima). The green lines represent the results after [TIMA](#tima) with [MS](#ms)^1^-based annotation completion. Dashed lines represent the results obtained with an in-house structure-pair organisms library in addition to the LOTUS library. A focus on the first 25 ranks is available in the upper right.](images/ci-9.pdf "ci-9"){#fig:ci-9 short-caption="Percentage of Correct Annotations as Function of the Rank" align="center" width="100%"}

After weighting, the correct candidates had lower ranks, with a slight difference depending on the structural library used to search for structure-organism pairs (pink and blue lines).
The total number of correct candidates remained the same, in contrast to when the candidates obtained by spectral matching were complemented by candidates from the restricted [MS](#ms)^1^ annotation (green lines).
Performance increased to nearly 30% of correctly annotated candidates at rank 1 and 40% overall.
It is worth mentioning that of the 22,251 spectra that made up the reference set, only 13,936 (62%) had their structure in the structural library used for annotation. 
This highlights the importance of the libraries and the need to find better ways to access and prioritize them.

### Improving Usability

To improve the usability of [TIMA](#tima) and target a broader audience, multiple technical improvements were implemented.
For example, all parameters used are now externalized in separate files, that are saved in order to be able to reproduce the process (for the user himself or for sharing).
Tests were implemented to ensure usability, and cover 95% of the code.
This is part of the "Good Usability Practices
in Scientific Software Development" [@doi:10.48550/arXiv.1709.00111].
This also make them easier to optimize programmatically.
The initial program was written mainly in R [@wikidata:Q206904], but came with steps made in other languages, making it more complex to use.
Therefore, every step is now written in R, and a package (<https://github.com/taxonomicallyinformedannotation/tima-r/releases>) is available to install all required components.
Each step is also documented in <https://taxonomicallyinformedannotation.github.io/tima-r/articles/>.

![**Logo of the TIMA R package**](images/logo.pdf "tima-logo"){#fig:tima-logo short-caption="Logo of the TIMA R package" align="center" width="23%"} 

\newpage