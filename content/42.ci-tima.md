## TIMA {.page_break_before}

This chapter describes improvements that were made to the *Taxonomically Informed Metabolite Annotation* ([TIMA](#tima)) workflow (see Chapter @sec:tima) after publication [@doi:10.3389/fpls.2019.01329].
It addresses the main weaknesses of the published version of the [TIMA](#tima), namely:

- The lack of an accessible chemical compounds occurrences library
- The inability to annotate unconventional adducts
- The complexity of the whole architecture and its automation possibilities

### Library

The major limitation of [TIMA](#tima) was the accessibility to structure-organism pairs.
Main resources offering this kind of information were either limited to given organisms, difficult to access in an automatized way or closed at the time.
The *Lotus initiative* (Chapter @sec:lotus) addressed this point.
Each potential user can now easily access LOTUS documented structure-organism pairs through various endpoints and use them in [TIMA](#tima).
Different functions to directly download LOTUS locally, complement it with user-specific pairs, and limit the library to given branches of the tree of life are available.
The number of [2D](#dd) structures able to be re-ranked according to their producing organisms raised to over 140,000.

### Adducts

Another strong limitation was the dependency on the quality and quantity of the initial annotations.
Given the inability of various tools to annotate other ions than [M+H]^+^, this was a strong limiting factor.
While annotation tools evolved to overcome these limitations (the [ISDB](#isdb) can now also annotate [M-H]^-^ ions, for example), solutions to overcome this directly in [TIMA](#tima) were implemented.
The first step was to implement adduct detection based on mass differences of detected features in small retention windows.
Based on a list of common adducts (available at <https://github.com/taxonomicallyinformedannotation/tima-r/blob/main/inst/extdata/source/adducts.tsv>), the expected mass difference between both adducts is calculated.
For example, the [M+NH~4~]^+^ adduct of a molecule corresponds to [M] + 18.03383, while  [M+Na]^+^ to [M] + 22.98977.
The expected mass difference between both adducts is therefore 22.98977 - 18.03383 = 4.95594.
Therefore, if two features with a mass difference of 4.95594 Â± 10ppm (or any other tolerance) are found in a 0.1min time window (or any other tolerance), they are annotated as [M+NH~4~]^+^ and [M+Na]^+^.
These adducts are then compared to the library, for which the mass of each adducted form of all [MF](#mf)s was calculated.
The same reasoning is also applied afterward with a list of common neutral losses.
This leads to additional [MS](#ms)^1^-based annotations in complement to the ones generated by classical annotation workflows.
While these annotations are only based on exact mass matches, their intrinsic score is considered 0.
They are only kept if they are supported by the taxonomic weight with a given threshold, or by the newly introduced weight, the chemical consistency.

### Chemical Consistency

As shown in Figure @fig:taxo-1, a structural consistency term was foreseen to complement well the spectral similarity and taxonomic scores.
At the time of publication, this score was not implemented.
It is now in the form of a chemical consistency score.
A chemical class is attributed to the feature, either through the class of its structural annotation, or by the canopus module from Sirius [@doi:10.1038/s41587-020-0740-8], according to the origin of the initial annotations.
Default chemical classes attributed are the ones of NPClassifier [@doi:10.1021/acs.jnatprod.1c00399].
Then, a consensus chemical class is calculated with the neighbors in the [MN](#mn).
The chemical classes of all neighboring features are taken into account, a consistency score is calculated and if the chemical class is considered consistent, it is added to the feature.
This process uses the edges of the [MN](#mn), thus requiring spectra to be clustered before re-ranking the annotations.
As this process uses the commonly misinterpreted concept of neighboring features, common misconceptions of the relations between features are therefore illustrated in Figure @fig:ci-7.

![**Common misconceptions of feature relationships in [MN](#mn).** Two schematic clusters are illustrated, with some classical misinterpretations of the network.](images/ci-7.pdf "ci-7"){#fig:ci-7 short-caption="Common Misconceptions of Feature Relationships in [MN](#mn)" align="center" width="100%"}

Unlike commonly perceived, the main information in [MN](#mn) is in the edges and not the clusters. Clusters can be heavily influenced by the [MN](#mn) size and can be artificially broken because of the maximum components they can contain.
To compensate for the above-mentioned, setting the maximum component size to 0 is strongly suggested when building an [MN](#mn), in order to maximize the amount of information captured.
Moreover, edges are often artificially limited to 10, to have less congested [MN](#mn)s, but this results in a loss of information.
Setting it to the actually allowed maximum (20, because of computation heaviness) is also strongly suggested.
Finally, complementing the spectral siimilarity edges with [IIN](#iin) edges is also a way to improve the chemical consistency calculation.
IIN will add additional edges through [MS](#ms)^1^-based corelations, thus linking corelated features that were not before.

The inclusion of the LOTUS library, related [MS](#ms)^1^ annotation step, and chemical consistency reranking in the [TIMA](#tima) process is illustrated in Figure @fig:ci-6.

![**Illustration of the improved [TIMA](#tima) process.** Initial annotations are optionally complemented with [MS](#ms)^1^-based annotations from LOTUS, then reranked based on the biological taxonomy score and further reranked based on the chemical taxonomy score.](images/ci-6.pdf "ci-6"){#fig:ci-6 short-caption="Illustration of the Improved [TIMA](#tima) Process" align="center" width="100%"}

The improved [TIMA](#tima) process allows for [MS](#ms)^1^-based annotation in addition to the initial [MS^2^](#msms) annotations.
After this optional complementation step, it calculates a first score, based on biological taxonomy, and reranks the candidates accodringly (see Chapter @sec:tima).
It finally calculates a chemical consistency score and further reranks the candidates.  

### Benchmarking of the Improved Annotation Performance

Thanks to the improvements detailed above and the growth of publically available data, the initial benchmarking set of 2,107 spectra (see Figure @fig:taxo-4) could be extended to 22,251.
This benchmarking is the same as illustrated in Figure @fig:ci-5.
A comparison of the annotation performance prior to and post [TIMA](#tima) is illustrated in Figure @fig:ci-8.

![**Comparison of the annotation performance prior to and post [TIMA](#tima).** In panel A, the distribution of the scores obtained before and after weighting are illustrated (the correct annotations are in blue, the incorrect in red). In panel B, the distribution of the obtained ranks are illustrated.](images/ci-8.pdf "ci-8"){#fig:ci-8 short-caption="Comparison of the Annotation Performance Prior to and Post [TIMA](#tima)" align="center" width="100%"}

As mentioned previously, the scores obtained using spectral similarity are not informative (they are almost equaly distributed from 0 to 1 for the correct annotations).
In this sense, no confidence can be attributed to annotations.
In contrast, after weighting, the scores from the correct and incorrect annotations split into two distinct categories (Figure @fig:ci-8, panel A, right).
Ranking of correct candidates is also improved.
A more detailed view of the contribution of the different improvements is illustrated in Figure @fig:ci-9.

![**Percentage of correct annotations as function of the rank.** The lines show the percentage of correct annotations as a function of the rank. The pink line represents the results from the [ISDB](#isdb) annotation without weighting. The blue lines represent the results after [TIMA](#tima). The green lines represent the results after [TIMA](#tima) with [MS](#ms)^1^-based annotation completion. Dashed lines represent the results obtained with an inhouse structure-pair organisms library in addition to the LOTUS library. A zoom on the first 25 ranks is avaliable on the uper right.](images/ci-9.pdf "ci-9"){#fig:ci-9 short-caption="Percentage of Correct Annotations as Function of the Rank." align="center" width="100%"}

After weighing, correct candidates are better ranked, with a slight difference depending on the library used for structure-organism pairs retrieval (pink line versus blue lines).
The total number of correct candidates remains the same.
This is not the case when complementing candidates obtained by spectral matching with candidates from a restricted [MS](#ms)^1^ annotation (green lines).
The performance increases drastically, reaching almost 30% of candidates correctly annotated at rank 1 and 40% in total.
It is worth mentioning that, out of the 22,251 spectra constituting the reference set, only 13,936 of them (62%) have their structure in the library used for the annotation.
This further highlights the importance of the library used for annotation and the need for better ways to access and prioritize them.

### Improving Use

`//TODO`{.red}.

#### Reducing Complexity

number of languages, manual steps

`//TODO`{.red}.

#### Packaging and Documentation

`//TODO`{.red}.
\captionsetup[figure]{list=no}
`//TODO`{.red}. ![](images/logo.svg "tima-logo"){#fig:tima-logo align="right" width="30%"}
\captionsetup[figure]{list=yes}

`//TODO`{.red}.

`//TODO`{.red}.

\newpage