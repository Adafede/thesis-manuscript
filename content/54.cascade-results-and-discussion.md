## Results and Discussion

This section is structured as follows: 
First, an overview of the process is illustrated.
The main technical elements are then detailed.
Then, the different results of the process are illustrated and the added value of the approach is demonstrated for a typical plant ethanolic extract of industrial interest, *Swertia chirayita* (Roxb.) H. Karst.
In addition, a comparison of the results with the literature is shown.
Some of the limitations of the method, related to peak shape and annotation are finally presented.

### Workflow

A scheme of the general workflow is presented in Figure @fig:cascade-1.

![**Schematic view of the presented workflow.** After the LC-MS/MS-CAD acquisition, the data are subjected to several processing steps. On the CAD side, a first pre-processing step is performed to enhance the signal. Then, peaks are automatically detected and integrated. On the MS/MS side, features are detected, grouped according to Ion Identity Networking and clustered into a Molecular Network. They are then annotated at the chemical class and/or structure level. A peak shape similarity calculation then links together the CAD peaks and MS features. An additional feature filtering step based on the knowledge of the sample can be performed. This provides combined qualitative and semi-quantitative information that can be explored in multiple ways.](images/cascade_workflow.pdf "cascade-1"){#fig:cascade-1 short-caption="Schematic View of the Presented Workflow" width="100%"}

As a minimal input, the workflow requires LC-MS/MS data, supplemented by another detector (here CAD and PDA, as described in [Data Acquisition](#data-acquisition)).
It then needs to be converted to an open format such as mzML, with all detectors encoded into the same file (see [Data Conversion](#data-conversion)).
Multiple processing steps then follow and will be detailed in the next subchapters.
First, signals are aligned as described in [Signals Alignment](#signals-alignment).
Being very noisy, the CAD required additional processing as described in [CAD Processing](#charged-aerosol-detector-cad-processing).
After several signal processing steps described below, a qualitative and semi-quantitative report is generated, as well as visual means to interrogate the data.
In parallel, MS features are extracted, clustered, and annotated, as described in [MS/MS Processing](#tandem-mass-spectrometry-msms-processing).
Afterward, MS features are attributed to CAD peaks as described in [Link Between CAD and MS Data](#link-between-cad-and-ms-data).
This allows signals to be categorized as belonging to 'major' or 'minor' metabolites.
Finally, to facilitate further investigation, different automated numerical and visual reports are generated as described in [Data Visualization](#data-visualization).

### Data Acquisition 

`//TODO`{.red} Introduce data acquisition but mainly in M&M.

### Data Conversion 

All raw data files were converted using ThermoRawFileParser [v.1.4.0](https://github.com/compomics/ThermoRawFileParser/releases/tag/v1.4.0) [@doi:10.1021/acs.jproteome.9b00328].
Currently, only ThemoRawFileParser is able to encode the CAD signal directly in the mzML file from the raw file (with the `--allDetectors` option).
This feature was added by the authors of the tool on our request (see <https://github.com/compomics/ThermoRawFileParser/pull/87> and <https://github.com/compomics/ThermoRawFileParser/issues/60>. 

Once converted, the mzML file contained all requested signals, with their related chromatograms and spectra.
The chromatograms were encoded as `BasePeak_0` for the BPI chromatogram, `PDA.1_TotalAbsorbance_0` for the UV chromatogram, and `UV.1_CAD_1_0` for the CAD chromatogram.

### Data Processing

#### Signals Alignment

The first necessary step was to align the signals of the different detectors. 
In the configuration used, the non-destructive PDA detector was placed first, before the split.
The MS signal was delayed by 0.090 and 0.055 minutes in comparison to the one of the PDA and the CAD, respectively.
These values were used to align the signals as shown in Figure @fig:cascade-2.

![**Alignment of the different signals after preprocessing of each signal.** All signals were preprocessed to improve the downstream steps. CAD and PDA signals are at the top, in red and green, respectively. MS signals (positive and negative modes) are at the bottom, in light and dark blue, respectively. A zoomed-in area showing the different intensities normalized to the observed signal is also illustrated.](images/cascade_example_chromatogram.pdf "cascade-2"){#fig:cascade-2 short-caption="Alignment of the Different Signals After Preprocessing of Each Signal" width="100%"}

Figure @fig:cascade-2 highlights the complementarity between each signal obtained.
While the PDA intensity approximately follows the CAD intensity when a signal is present, some major molecules without a chromophore are ignored if UV only is used.
The same is true for MS ionization modes (see light and dark blue traces).
Although the presented approach also works with a single MS ionization mode, it is highly recommended to use both to improve coverage.

#### Charged Aerosol Detector (CAD) Data

As the CAD signal was very noisy, it required some preprocessing steps before peak extraction. 
These are briefly described hereafter and more in detail in the related Materials and Methods section.
First, a Fourier transform was performed, to keep only 1% of the components.
Fourier transform techniques to reduce noise were already demonstrated as powerful [@doi:10.1016/j.trac.2021.116354].
This already allowed to greatly lower signal interferences.
Moreover, the chromatographic resolution was improved using the derivative enhancement approach as described in [@doi:10.1016/j.talanta.2018.09.048].
This resulted in a sharper signal, where peak detection could be performed with better results than on the raw signal. 
To ensure the same processing between the different detectors, this was also done on the other signals.

Peaks were then integrated using simple algorithmic as CAD signal contains only one dimension, thus not allowing for more elaborated techniques, such as the ones used in MS and PDA peak detection.
A comparison of the peaks detected automatically before and after signal processing is shown below.

![**Comparison of peak detection on the raw and processed signal.** The results of the automated peak picking on the raw signal are shown on the top. Before processing, no peaks are detected due to the noise in the signal. The result of the peak detection and integration on the processed signal is shown at the bottom. Almost no peak is lost and only poorly-shaped peaks are split. A zoomed-in area showing more into detail the signal differences is also illustrated.](images/cascade-3.pdf "cascade-3"){#fig:cascade-3 short-caption="Comparison of Peak Detection on the Raw and Processed Signal" width="100%"}

Multiple iterations were performed in order to find parameters allowing at the same time to pick small peaks not splitting big ones (data not shown).
The result illustrated in Figure @fig:cascade-3 appeared as the best compromise.
While no peaks were automatically integrated before proocessing (top of the Figure), the majority of human-visible peaks were correctly integrated (bottom of the Figure).
Very small, poorly defined peaks are not picked, while major peaks are, thus allowing for good CAD peak-shape comparison with MS features later on.
Even if the manual integration of such data would perform better, automated pick peaking is still a challenging problem, as illustrated by diverse recent efforts trying to include machine learning to solve it [@doi:10.1021/acs.analchem.9b04811; @doi:10.1021/acs.analchem.1c02220].

#### High-Resolution Tandem Mass Spectrometry (HR-MS/MS) Data

##### Features Extraction 

MS features were extracted using MZmine3 v.3.1.0-beta `//TODO REF`{.red}. 
Trials were also made using Sirius 5.7.0 `//TODO REF`{.red}.
The main advantage of Sirius was that it did not require any parameter, thus making it optimal for automation.
As the peak picking algorithmic and adduct recognition was written by the authors of the tool themselves, downstream steps performed better.
Sirius performed well in the positive ionization mode, but the negative ionization mode led to inconsistencies thus MZmine3 was preferred for both modes (data not shown).
Peakonly [@doi:10.1021/acs.analchem.9b04811] was also used, but its integration with the rest of the workflow, needing finely defined isotope patterns, also led to worse performances.
Finally, some tests were performed using SLAW [@doi:10.1021/acs.analchem.1c02687], but they did not reach the performance of Sirius and MZmine3.
Integration of MZmine3 and IIN in SLAW in the future might improve a lot its performance and speed.

The MGF and the IIN edges used to build an MN through the GNPS platform (see [fd78b0a89d6d40168fc43d5f13f71688](https://gnps.ucsd.edu/ProteoSAFe/status.jsp?task=fd78b0a89d6d40168fc43d5f13f71688) for positive and [033b5dcf471641c09907704696b82bb0](https://gnps.ucsd.edu/ProteoSAFe/status.jsp?task=033b5dcf471641c09907704696b82bb0) for negative).
The IIN was complemented using the MS1 adduct module of TIMA v2.5.5 [@doi:10.5281/zenodo.6929297].
Thus, adducts, multimers, and fragments generated by the same molecule could be annotated as such, even without structural annotation.

##### Features Annotation 

MS features were annotated using a multi-tool approach.
They were annotated using Sirius 5.7.0 and complemented with annotations coming from the GNPS libraries, together with ISDB-LOTUS.
Such an approach allows using the strengths of each tool while reducing weaknesses thanks to the other ones.
The combination of the annotations of all three tools was then submitted to taxonomically informed metabolite annotation.
This way, multi-charged molecules, for example, could be annotated.
After this, only the best candidate (based on the final score after *taxonomically informed scoring*) was kept for later steps.
Further, only confident best candidates were kept.
All details are given in the corresponding Materials and Methods section.

In positive mode, this led to XXX `//TODO`{.red} annotations, of which XXX `//TODO`{.red} were confident (XX,X%) on 3,610 features.
In negative mode, this led to XXX `//TODO`{.red} annotations, of which XXX `//TODO`{.red} were confident (XX,X%) annotations on 2,312 features.

#### Link Between CAD and MS Data

Independently from features annotation, CAD and MS peaks shapes were compared.
As CAD peaks could contain multiple features, features with the best peak-shape correlation with the CAD peak were also the most legitimate ones to account for the CAD signal.
As a first mandatory step, all points of CAD and MS peaks were inter- and extrapolated to the same frequency,to be defined with approximately the same number of points.
This is generally not needed as peak shapes usually compared, are coming from the same detector.
This usually results in the same frequency of acquisition. Here, since the frequency of the CAD is approximately 30 times higher than the one of MS, resampling was performed.

The second step consisted of normalizing the peak’s intensity together with a retention time normalization between the two peak’s minima.
The aim of this procedure was to improve peak shape similarity between the compounds whose ionization strongly differs from the CAD trace.
Without this step, the MS features with the highest intensity would by default have a more defined peak shape and thus be more likely to be correlated to the CAD signal.

Only features with a similarity ≥ 0.6 were considered as correlated as a first step.
They were then refined to ≥ 0.8, with the possibility to change both thresholds independently.

If an MS feature had a correlation ≥ 0.8, its corresponding annotation was considered as a "major" compound, else, it was categorized as a "minor" compound.
This allowed distinguishing major and minor features even if they were all found below the same CAD peak.
All features outside of a CAD peak were considered “minor” by default.
The higher the peak capacity [@doi:10.1021/ac50157a075], the better the classification.
Future applications, such as core–shell or sub-micrometer porous particles packed columns [@doi:10.1016/j.chroma.2014.11.069], are expected to greatly help in this regard.  

CAD peaks could envelop multiple or only a few (non-)correlated features.
An example of a CAD peak containing multiple MS-features in both positive and negative ionization modes is illustrated in Figure @fig:cascade-4.

![**Link Between MS-features and CAD Peak.** Each panel is composed of positive and negative ionization modes (negative ionization mode shown as negative values). The MS features are represented with plain lines and CAD peak with dashed line. On panel A, features are colored according to their peak shape similarity with the CAD peak. On panel B, features are colored according to the molecular formula of the best candidate. On panel C, features are colored according to the 2D structure of the best candidate. On panel D, features are colored according to the `biological score` part of the *taxonomically informed scoring* (a value close to one indicates the 2D structure has already been reported in a similar organism).](images/cascade-4.pdf "cascade-4"){#fig:cascade-4 short-caption="Link Between MS-features and CAD Peak" align="center" width="100%"}

Each panel is composed of positive and negative ionization modes (negative ionization mode shown as negative values). 
The MS features are represented with plain lines and CAD peak with dashed line.

First, on panel A, features are colored according to their peak shape similarity with the CAD peak. 
In the example, peaks with a higher intensity also share a higher similarity.
This is mainly due to the fact that because of their intensity, their peak shape is initially better defined.
The resampling step described before helped to limit the effect of intensity on peak shape similarity calculation.
Nevertheless, MS-features with low intensity are less likely share a good peak shape similarity with the CAD peak. 

On panel B, features are colored according to the molecular formula of the best candidate.
Formulas occuring less than two times were grouped in the "other" category.
A good consistency between the annotations in positive and negative modes can be observed, with C~30~H~48~O~3~ being the most consistent formula.
The features annotated consistently also share good peak shape similarity on panel A. 

On panel C, features are colored according to the 2D structure of the best candidate.
Structures occuring less than two times were grouped in the "other" category.
This further refines panel B, showing that some of the features annotated with the same molecular formula, C~30~H~48~O~3~, do not share the same structural annotation (MIJYXULNPSFWEK and WCGUUGGRBIKTOS, both triterpenoid derivatives).

On panel D, features are colored according to the `biological score` part of the *taxonomically informed scoring*. 
A value close to one indicates the 2D structure has already been reported in a similar organism than the one studied (here, *S. chirayita*).
Both MIJYXULNPSFWEK and WCGUUGGRBIKTOS corresponded to 2D structures already reported in *S. chirayita* [@doi:10/bqwnm4].

All together, the different relations between these features could help gaining information while reducing the complexity of the data.
Informed data dimensionality reduction is detailed in the next subchapter.

#### Dimensionality Reduction 

Having all features informed as previously described, guided data dimensionality reduction could occur.
This step was necessary to further narrow down the amount of information to be finally analyzed by humans.
Basic statistics illustrating the number of features for each ionization mode, together with their link to their attributes are given in Table @tbl:cascade-1.

Table: Initial MS-features - CAD peaks Statistics {#tbl:cascade-1}

|                                 |       **Positive**       |        **Negative**      |
|:------------------------------- | ------------------------:| ------------------------:|
| Total features                  | 3,610                    | 2,312                    | 
| Ion identity groups             | XXX                      | XXX                      | 
| CAD peaks                       | 44                       | 38                       | 
| Features linked to CAD peak     | 714                      | 489                      |
| Features per peak               | 16.2                     | 12.9                     | 
| Structures per peak             | XXX                      | XXX                      | 
| Molecular formulas per peak     | XXX                      | XXX                      | 
| Chemical classes per peak       | XXX                      | XXX                      | 

mean(df_meta_cad_pos |> dplyr::filter(peak_id!=0) |> dplyr::pull(featuresPerPeak_old))

`//TODO DEVELOP`{.red}
`//TODO`{.red} say linked to cad peak = major

These metrics can also be used to evaluate the peak purity [@doi:10/dx5qvh; @doi:10/bjmvb9].
The concept of peak purity could then be used  to evaluate the quality of the acquired framentation sppectrum [@doi:10.1021/acs.analchem.6b04358], or even try to deconvoute it [@doi:10.1021/ac400751j].

As previously described, while positive ionization mode is usually preferred as it is expected to be more generic, the ionization efficiency (ratio to noise) is better in negative ionization mode [@doi:10.1021/acs.analchem.7b00096].

`//TODO DEVELOP`{.red}

Table: Peak Shape Similarity Filtered Features Statistics (Positive Mode) {#tbl:cascade-2}

|                                 |   Before similarity filter  |   After similarity filter   |
|:------------------------------- | ---------------------------:| ---------------------------:|
| Total features                  | 3,610                       | 3,610                       | 
| Total CAD peaks                 | 44                          | 44                          | 
| Features linked to CAD peak     | 714                         | 284                         |
| Features per peak               | 16.2                        | 6.5                         | 
| Structures per peak             | XXX                         | XXX                         | 
| Molecular formulas per peak     | XXX                         | XXX                         | 
| Chemical classes per peak       | XXX                         | XXX                         | 

mean(df_meta_cad_pos |> dplyr::filter(peak_id!=0) |> dplyr::pull(correlatedFeaturesPerPeak_old))

The correspoonding Table for negative mode is avaiable in Appendix @sec:appendix-cascade-1. 

`//TODO`{.red}

As this filtering process was effective but not sufficient, an additional filter was implemented to further narrow down the major compounds.
This filter consisted in favoring compounds already known in the genus of the studied extract.
If the compound was already isolated from the same source, the probability it is a major compound is higher. 
If a compound was found in the studied species, all other "major" candidate compounds were switched to the "minor" category, except if also found in the species.
The same rule was then applied to the genus, with precedence to the species' compounds.
This led to less features considered as "major", as decribed in Table @tbl:cascade-3.

Table: Peak Shape Similarity and Taxonomy Filtered Features Statistics (Positive Mode) {#tbl:cascade-3}

|                                 | After similarity filter only|After both filters (similarity+taxonomy) |
|:------------------------------- | ---------------------------:| ---------------------------:|
| Total features                  | 3,610                       | 3,610                       | 
| Total CAD peaks                 | 44                          | 44                          | 
| Features linked to CAD peak     | 284                         | 66                          |
| Features per peak               | 6.5                         | 1.5                         | 
| Structures per peak             | XXX                         | XXX                         | 
| Molecular formulas per peak     | XXX                         | XXX                         | 
| Chemical classes per peak       | XXX                         | XXX                         | 

mean(df_meta_cad_pos |> dplyr::filter(peak_id!=0) |> dplyr::pull(finalFeaturesPerPeak_old))

The corresponding Table for negative mode is avaiable in Appendix @sec:appendix-cascade-2. 

`//TODO DEVELOP`{.red}

An alluvial plot illustrating the filtering process on the positive ionization data is proposed in @fig:cascade-5.

![**Alluvial Plot of the Informed Data Filtering Process.** TODO](images/cascade-5.pdf "cascade-5"){#fig:cascade-5 short-caption="Alluvial Plot of the Informed Data Filtering Process" align="center" width="100%"}

`//TODO DEVELOP`{.red}

A pseudo-chromatogram illustrating the biological provenance of the annotated compounds in regard to the extract biological source is proposed in Figure @fig:cascade-6.

![**Taxonomically Informed Pseudochromatograms**. TODO](images/cascade-6.pdf "cascade-6"){#fig:cascade-6 short-caption="Taxonomically Informed Pseudochromatograms" align="center" width="100%"}

`//TODO DEVELOP`{.red}

### Data Visualization

Small intro `//TODO`{.red}

#### Pseudo Chromatogram

With numbers and stars `//TODO`{.red}

![**TODO**](images/cascade-7.pdf "cascade-7"){#fig:cascade-7 short-caption="Chemically Informed Pseudochromatogram" align="center" width="100%"}

#### Automated Reports

Html tables `//TODO`{.red}

#### CAD-Informed Molecular Network (MN)

Show example(s)?  `//TODO`{.red}

### Literature Matching

`//TODO`{.red}

As an approximation of compounds present in the extracts, a query of reported compounds in the producing organism was performed on Wikidata, which is now the largest occurrences resource for natural products.
The returned list of compounds for each producing organism was then filtered to better match the LC-MS run conditions 

`//TODO`{.red} (see Material and Methods).

A comparison between the composition obtained by LC-MS and the one reported in the literature is illustrated below.

Show example(s)?  `//TODO`{.red}

### Edge Cases

`//TODO`{.red}

#### Elution Peak

Maybe HILIC example for discussion `//TODO`{.red}

#### Number of Apex and Clusters Below a Single CAD Peak

`//TODO`{.red}

### Other

`//TODO`{.red}

Charged aerosol detector response modeling for fatty acids based on experimental settings and molecular features: a machine learning approach [@doi:10.1186/s13321-021-00532-0]

Universal response model for a corona charged aerosol detector [@doi:10.1016/j.chroma.2010.09.056]

Universal Response in Liquid Chromatography Using Charged Aerosol Detection [@doi:10.1021/ac060078j]

Aerosol-Based Detectors in Liquid Chromatography [@doi:10.1002/9781119390725.ch4]

Effects of eluent temperature and elution bandwidth on detection response for aerosol-based detectors [@doi:10.1016/j.chroma.2013.07.111]

Comparison of the response of four aerosol detectors used with ultra high pressure liquid chromatography [@doi:10.1016/j.chroma.2011.01.062]

Power function setting in charged aerosol detection for the linearization of detector response – optimization strategies and their application [@doi:10.1016/j.chroma.2020.461844]

Revealing the inner workings of the power function algorithm in Charged Aerosol Detection: A simple and effective approach to optimizing power function value for quantitative analysis [@doi:10.1016/j.chroma.2019.04.017]


Chose which one as good compromise `//TODO`{.red}

Calculated peak capacity (400g/mol, 40°C) (HPLC Calculator version 3.1): [@doi:10.1016/j.ejpb.2007.06.018]

050x2.1x1.7, 07 min 600uL: **199**

050x2.1x1.7, 07 min 900uL: **204**

050x2.1x1.7, 21 min 600uL: **251**

100x2.1x1.7, 21 min 500uL: **307**

150x2.1x1.7, 42 min 400uL: **393**

150x2.1x1.7, 126 min 400uL: **480**

Show increasing peak purity `//TODO`{.red}
